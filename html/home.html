<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>DatLV - Dashboard</title>
   <link rel="stylesheet" href="../css/home.css">
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
   <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
   <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
   <script src="../js/home.js"></script>
   <script>
      $(document).ready(function () {
         // load data login
         function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
         }
         const dataFromQueryParam = getQueryParam('data');
         const dataFromQueryParamObject = JSON.parse(dataFromQueryParam);
         console.log(dataFromQueryParamObject);
         dataFromQueryParamObject.statusGoogle = false
         dataFromQueryParamObject.statusFacebook = false
         dataFromQueryParamObject.statusGithub = false
         localStorage.setItem('dataFromQueryParamObject', JSON.stringify(dataFromQueryParamObject));

         // load data to interface
         try {
            $('#imgUserLogin').attr('src', dataFromQueryParamObject.image);
         } catch (error) {
            console.log(error);
         }
         $('#mainTitle').text(`Welcome back, ${dataFromQueryParamObject.email} !`);

         for (let i = 0; i < dataFromQueryParamObject.socialAccounts.length; i++) {
            if (dataFromQueryParamObject.socialAccounts[i].provider == 'google') {
               $('#google').text(dataFromQueryParamObject.socialAccounts[i].email);
               $('#statusConnectGoogle').text('Connected');
               $('#statusConnectGoogle').removeClass('btn-light');
               $('#statusConnectGoogle').addClass('btn-success');
               dataFromQueryParamObject.statusGoogle = true;
               localStorage.setItem('dataFromQueryParamObject', JSON.stringify(dataFromQueryParamObject));
            }

            if (dataFromQueryParamObject.socialAccounts[i].provider == 'facebook') {
               $('#facebook').text(dataFromQueryParamObject.socialAccounts[i].firstName + ' '
                  + dataFromQueryParamObject.socialAccounts[i].lastName);
               $('#statusConnectFacebook').text('Connected');
               $('#statusConnectFacebook').removeClass('btn-light');
               $('#statusConnectFacebook').addClass('btn-success');
               dataFromQueryParamObject.statusFacebook = true;
               localStorage.setItem('dataFromQueryParamObject', JSON.stringify(dataFromQueryParamObject));
            }

            if (dataFromQueryParamObject.socialAccounts[i].provider == 'github') {
               $('#github').text(dataFromQueryParamObject.socialAccounts[i].firstName);
               $('#statusConnectGithub').text('Connected');
               $('#statusConnectGithub').removeClass('btn-light');
               $('#statusConnectGithub').addClass('btn-success');
               dataFromQueryParamObject.statusGithub = true;
               localStorage.setItem('dataFromQueryParamObject', JSON.stringify(dataFromQueryParamObject));
            }
         }

         // handle relink
         // if (dataFromQueryParamObject.message) {
         //    alert(dataFromQueryParamObject.message);
         //    delete dataFromQueryParamObject.message;
         //    delete dataFromQueryParamObject.statusCode;
         //    localStorage.setItem('dataFromQueryParamObject', JSON.stringify(dataFromQueryParamObject));
         // }

         // handle link/unlink button google
         $('#statusConnectGoogle').click(function () {
            try {
               if (dataFromQueryParamObject.statusGoogle == false) {
                  dataFromQueryParamObject.statusGoogle = true;
                  localStorage.setItem('dataFromQueryParamObject', JSON.stringify(dataFromQueryParamObject));
                  window.location.href = 'http://localhost:3000/googleRelink';
                  return;
               }
            } catch (error) {
               alert(error.message);
               alert('Account linked to another account!');
               window.location.href = 'http://localhost:5501/html/home.html';
            }

            const confirmUnlinkGoogle = confirm('Are you sure to unlink this google account?');
            if (confirmUnlinkGoogle == false) {
               return;
            }

            const emailGoogle = dataFromQueryParamObject.socialAccounts.filter(function (item) {
               return item.provider == 'google';
            })[0].email;

            if (dataFromQueryParamObject.statusGoogle == true) {
               $.ajax({
                  url: 'http://localhost:3000/graphql',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify({
                     query: `mutation unlinkConnectedGoogle {
                           unlinkConnectGoogle(email: "${emailGoogle}") {
                              email
                           }
                        }`
                  }),
                  success: function (result) {
                     console.log(result);
                     $('#google').text('Google');
                     $('#statusConnectGoogle').text('Not connected');
                     $('#statusConnectGoogle').removeClass('btn-success');
                     $('#statusConnectGoogle').addClass('btn-light');
                     dataFromQueryParamObject.statusGoogle = false;
                     // delete data of dataFromQueryParamObject.socialAccounts have provider is google
                     for (let i = 0; i < dataFromQueryParamObject.socialAccounts.length; i++) {
                        if (dataFromQueryParamObject.socialAccounts[i].provider == 'google') {
                           dataFromQueryParamObject.socialAccounts.splice(i, 1);
                        }
                     }
                     console.log(dataFromQueryParamObject);

                     localStorage.setItem('dataFromQueryParamObject', JSON.stringify(dataFromQueryParamObject));
                  }
               })
            } else {
               // call ajax to insert data
            }
         })

         // handle link/unlink button facebook
         $('#statusConnectFacebook').click(() => {
            try {
               if (dataFromQueryParamObject.statusFacebook == false) {
                  dataFromQueryParamObject.statusFacebook = true;
                  localStorage.setItem('dataFromQueryParamObject', JSON.stringify(dataFromQueryParamObject));
                  window.location.href = 'http://localhost:3000/facebookRelink';
                  return;
               }
            } catch (error) {
               alert(error.message);
               alert('Account linked to another account!');
               window.location.href = 'http://localhost:5501/html/home.html';
            }

            const confirmUnlinkFacebook = confirm('Are you sure to unlink this facebook account?');
            if (confirmUnlinkFacebook == false) {
               return;
            }

            const emailFacebook = dataFromQueryParamObject.socialAccounts.filter(function (item) {
               return item.provider == 'facebook';
            })[0].email;

            if (dataFromQueryParamObject.statusFacebook == true) {
               $.ajax({
                  url: 'http://localhost:3000/graphql',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify({
                     query: `mutation unlinkConnectedFacebook {
                           unlinkConnectFacebook(email: "${emailFacebook}") {
                              email
                           }
                        }`
                  }),
                  success: function (result) {
                     console.log(result);
                     $('#facebook').text('Facebook');
                     $('#statusConnectFacebook').text('Not connected');
                     $('#statusConnectFacebook').removeClass('btn-success');
                     $('#statusConnectFacebook').addClass('btn-light');
                     dataFromQueryParamObject.statusFacebook = false;
                     // delete data of dataFromQueryParamObject.socialAccounts have provider is facebook
                     for (let i = 0; i < dataFromQueryParamObject.socialAccounts.length; i++) {
                        if (dataFromQueryParamObject.socialAccounts[i].provider == 'facebook') {
                           dataFromQueryParamObject.socialAccounts.splice(i, 1);
                        }
                     }
                     console.log(dataFromQueryParamObject);

                     localStorage.setItem('dataFromQueryParamObject', JSON.stringify(dataFromQueryParamObject));
                  }
               })
            } else {
               // call ajax to insert data
            }
         })

         $('#statusConnectGithub').click(() => {
            try {
               if (dataFromQueryParamObject.statusGithub == false) {
                  dataFromQueryParamObject.statusGithub = true;
                  localStorage.setItem('dataFromQueryParamObject', JSON.stringify(dataFromQueryParamObject));
                  window.location.href = 'http://localhost:3000/github';
                  return;
               }
            } catch (error) {
               alert(error.message);
               alert('Account linked to another account!');
               window.location.href = 'http://localhost:5501/html/home.html';
            }

            const confirmUnlinkGithub = confirm('Are you sure to unlink this github account?');
            if (confirmUnlinkGithub == false) {
               return;
            }

            const usernameGithub = dataFromQueryParamObject.socialAccounts.filter(function (item) {
               return item.provider == 'github';
            })[0].firstName;

            if (dataFromQueryParamObject.statusGithub == true) {
               $.ajax({
                  url: 'http://localhost:3000/graphql',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify({
                     query: `mutation unlinkConnectedGithub {
                           unlinkConnectGithub(username: "${usernameGithub}") {
                              firstName
                           }
                        }`
                  }),
                  success: function (result) {
                     console.log(result);
                     $('#github').text('Github');
                     $('#statusConnectGithub').text('Not connected');
                     $('#statusConnectGithub').removeClass('btn-success');
                     $('#statusConnectGithub').addClass('btn-light');
                     dataFromQueryParamObject.statusGithub = false;
                     // delete data of dataFromQueryParamObject.socialAccounts have provider is github
                     for (let i = 0; i < dataFromQueryParamObject.socialAccounts.length; i++) {
                        if (dataFromQueryParamObject.socialAccounts[i].provider == 'github') {
                           dataFromQueryParamObject.socialAccounts.splice(i, 1);
                        }
                     }
                     console.log(dataFromQueryParamObject);
                     localStorage.setItem('dataFromQueryParamObject', JSON.stringify(dataFromQueryParamObject));
                  }
               })
            } else {
               // call ajax to insert data
            }
         })
      });
   </script>
</head>

<body>
   <div class="container-fluid py-1 mx-auto"
      style="background-image: url('../images/bg-01.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="page-content page-container" id="page-content">
         <div class="padding">
            <div id="imageContainer" style="display: flex; justify-content: center; align-items: center;">
               <img src="" id="imgUserLogin" width="100px" style="border-radius: 50%;">
            </div>
            <div class="row text-center">
               <div class="col pb-5">
                  <div class="h1 text-light font-weight-bold">
                     <span id="mainTitle">
                        Social Accounts
                     </span>
                  </div>
               </div>
            </div>
            <div class="row">
               <div class="col">
                  <div class="container-fluid d-flex justify-content-center">
                     <div class="list list-row card" id="sortable" data-sortable-id="0" aria-dropeffect="move">
                        <div class="list-item p-4" data-id="13" data-item-sortable-id="0" draggable="true" role="option"
                           aria-grabbed="false">
                           <div>
                              <img src="../images/logo_google.png" width="30px" alt="" srcset="">
                           </div>

                           <div class="flex">
                              <div href="#" class="item-author text-color" data-abc="true">
                                 <span id="google">
                                    Google
                                 </span>
                              </div>
                           </div>
                           <div class="no-wrap">
                              <div class="item-date text-muted text-sm d-none d-md-block">
                                 <a href="#">
                                    <button id="statusConnectGoogle" class="btn btn-light">
                                       Not connected
                                    </button>
                                 </a>
                              </div>
                           </div>
                        </div>

                        <div class="list-item p-4" data-id="13" data-item-sortable-id="0" draggable="true" role="option"
                           aria-grabbed="false">
                           <div>
                              <img src="../images/logo_facebook.png" width="30px" alt="" srcset="">
                           </div>
                           <div class="flex">
                              <div href="#" class="item-author text-color" data-abc="true">
                                 <span id="facebook">
                                    Facebook
                                 </span>
                              </div>
                           </div>
                           <div class="no-wrap">
                              <div class="item-date text-muted text-sm d-none d-md-block">
                                 <a href="#">
                                    <button id="statusConnectFacebook" class="btn btn-light">
                                       Not connected
                                    </button>
                                 </a>
                              </div>
                           </div>
                        </div>

                        <div class="list-item p-4" data-id="13" data-item-sortable-id="0" draggable="true" role="option"
                           aria-grabbed="false">
                           <div>
                              <img src="../images/logo_github.png" width="30px" alt="" srcset="">
                           </div>
                           <div class="flex">
                              <div href="#" class="item-author text-color" data-abc="true">
                                 <div id="github">
                                    Github
                                 </div>
                              </div>
                           </div>
                           <div class="no-wrap">
                              <div class="item-date text-muted text-sm d-none d-md-block">
                                 <a href="#">
                                    <button id="statusConnectGithub" class="btn btn-light">
                                       Not connected
                                    </button>
                                 </a>
                              </div>
                           </div>
                        </div>

                        <div class="list-item p-4" data-id="13" data-item-sortable-id="0" draggable="true" role="option"
                           aria-grabbed="false">
                           <div>
                              <img src="../images/logo_linkedin.png" width="30px" alt="" srcset="">
                           </div>
                           <div class="flex">
                              <div href="#" class="item-author text-color" data-abc="true">Linkedin</div>
                           </div>
                           <div class="no-wrap">
                              <div class="item-date text-muted text-sm d-none d-md-block">
                                 <a href="#">
                                    <button id="statusConnectLinkedin" class="btn btn-light">
                                       Not connected
                                    </button>
                                 </a>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</body>

</html>