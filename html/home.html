<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>DatLV - Dashboard</title>
   <link rel="stylesheet" href="../css/home.css">
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
   <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
   <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
   <script src="../js/home.js"></script>
   <script>
      $(document).ready(function () {
         // load data login
         function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
         }

         const dataFromQueryParam = getQueryParam('data');
         const dataFromQueryParamObject = JSON.parse(dataFromQueryParam);

         if (dataFromQueryParamObject.provider === 'google') {
            localStorage.setItem('yourLocalStorageKey', dataFromQueryParam);
            const savedData = localStorage.getItem('yourLocalStorageKey');
            console.log('Data from localStorage:', savedData);
            const dataObject = JSON.parse(savedData);
            $('#google').text(dataObject.email);
            $('#statusConnectGoogle').text('Connected');
            $('#mainTitle').text(`Welcome back ${dataObject.firstName} ${dataObject.lastName}!`);
            dataObject.statusGoogle = 'Connected';
            localStorage.setItem('yourLocalStorageKey', JSON.stringify(dataObject));
            $('#imgUserLogin').attr('src', dataObject.picture);
         }

         if (dataFromQueryParamObject.provider === 'facebook') {
            localStorage.setItem('yourLocalStorageKey', dataFromQueryParam);
            const savedData = localStorage.getItem('yourLocalStorageKey');
            console.log('Data from localStorage:', savedData);
            const dataObject = JSON.parse(savedData);
            $('#facebook').text(`${dataObject.firstName} ${dataObject.lastName}`);
            $('#statusConnectFacebook').text('Connected');
            $('#mainTitle').text(`Welcome back ${dataObject.firstName} ${dataObject.lastName}!`);
            dataObject.statusFacebook = 'Connected';
            localStorage.setItem('yourLocalStorageKey', JSON.stringify(dataObject));
            $('#imgUserLogin').attr('src', dataObject.picture);
         }

         // handle unlink/link google
         $('#statusConnectGoogle').click(() => {
            if ($('#statusConnectGoogle').text() === 'Not connected') {
               window.location.href = 'http://localhost:3000/google';
            } else {
               const confirmUnconnect = confirm('Are you sure to unconnect Google?');
               if (confirmUnconnect) {
                  $('#google').text('Google');
                  $('#statusConnectGoogle').text('Not connected');

                  const savedData = localStorage.getItem('yourLocalStorageKey');
                  const dataObject = JSON.parse(savedData);
                  dataObject.statusGoogle = 'Not connected';
                  localStorage.setItem('yourLocalStorageKey', JSON.stringify(dataObject));

                  const deleteGraphlQuery = `
                    mutation unlinkConnectedGoogle {
                        unlinkConnectGoogle(email: "${dataObject.email}") {
                            email
                        }
                    }
                `;

                  $.ajax({
                     url: 'http://localhost:3000/graphql',
                     method: 'POST',
                     contentType: 'application/json',
                     data: JSON.stringify({
                        query: deleteGraphlQuery
                     }),
                     success: (res) => {
                        console.log(res);
                     },
                     error: (err) => {
                        console.log(err);
                     }
                  });
               }
            }
         });

         // handle unlink/link facebook
         $('#statusConnectFacebook').click(() => {
            if ($('#statusConnectFacebook').text() === 'Not connected') {
               window.location.href = 'http://localhost:3000/facebook';
            } else {
               const confirmUnconnect = confirm('Are you sure to unconnect Facebook?');
               if (confirmUnconnect) {
                  $('#facebook').text('Facebook');
                  $('#statusConnectFacebook').text('Not connected');

                  const savedData = localStorage.getItem('yourLocalStorageKey');
                  const dataObject = JSON.parse(savedData);
                  dataObject.statusFacebook = 'Not connected';
                  localStorage.setItem('yourLocalStorageKey', JSON.stringify(dataObject));

                  $('#statusConnectFacebook').removeClass('btn-success');
                  $('#statusConnectFacebook').addClass('btn-light');

                  const deleteGraphlQuery = `
                  mutation unlinkConnectFacebook {
	                  unlinkConnectFacebook(email: "${dataObject.email}") {
		                  email
                        provider
                     }
                  } 
                `;

                  $.ajax({
                     url: 'http://localhost:3000/graphql',
                     method: 'POST',
                     contentType: 'application/json',
                     data: JSON.stringify({
                        query: deleteGraphlQuery
                     }),
                     success: (res) => {
                        console.log(res);
                     },
                     error: (err) => {
                        console.log(err);
                     }
                  });
               }
            }
         });

         // get loged in email
         const savedData = localStorage.getItem('yourLocalStorageKey');
         const dataObject = JSON.parse(savedData);
         const email = dataObject.email;

         const getGraphlQuery = `
         query getSocialAccountsByOwnerEmail {
  getSocialAccountsByOwnerEmail(email: "${email}") {
    id
    name
    email
    socialAccounts {
      id
      email
      provider
      picture
    }
  }
}`;

         $.ajax({
            url: 'http://localhost:3000/graphql',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
               query: getGraphlQuery
            }),
            success: (res) => {
               // save res to local storage
               localStorage.setItem('socialAccounts', JSON.stringify(res.data.getSocialAccountsByOwnerEmail));
            },
            error: (err) => {
               console.log(err);
            }
         });
         //end
      });



   </script>
</head>

<body>
   <div class="container-fluid py-1 mx-auto"
      style="background-image: url('../images/bg-01.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="page-content page-container" id="page-content">
         <div class="padding">
            <div id="imageContainer" style="display: flex; justify-content: center; align-items: center;">
               <img src="" id="imgUserLogin" width="100px" style="border-radius: 50%;">
            </div>
            <div class="row text-center">
               <div class="col pb-5">
                  <div class="h1 text-light font-weight-bold">
                     <span id="mainTitle">
                        Social Accounts
                     </span>
                  </div>
               </div>
            </div>
            <div class="row">
               <div class="col">
                  <div class="container-fluid d-flex justify-content-center">
                     <div class="list list-row card" id="sortable" data-sortable-id="0" aria-dropeffect="move">
                        <div class="list-item p-4" data-id="13" data-item-sortable-id="0" draggable="true" role="option"
                           aria-grabbed="false">
                           <div>
                              <img src="../images/logo_google.png" width="30px" alt="" srcset="">
                           </div>

                           <div class="flex">
                              <div href="#" class="item-author text-color" data-abc="true">
                                 <span id="google">
                                    Google
                                 </span>
                              </div>
                           </div>
                           <div class="no-wrap">
                              <div class="item-date text-muted text-sm d-none d-md-block">
                                 <a href="#">
                                    <button id="statusConnectGoogle" class="btn btn-light">
                                       Not connected
                                    </button>
                                 </a>
                              </div>
                           </div>
                        </div>

                        <div class="list-item p-4" data-id="13" data-item-sortable-id="0" draggable="true" role="option"
                           aria-grabbed="false">
                           <div>
                              <img src="../images/logo_facebook.png" width="30px" alt="" srcset="">
                           </div>
                           <div class="flex">
                              <div href="#" class="item-author text-color" data-abc="true">
                                 <span id="facebook">
                                    Facebook
                                 </span>
                              </div>
                           </div>
                           <div class="no-wrap">
                              <div class="item-date text-muted text-sm d-none d-md-block">
                                 <a href="#">
                                    <button id="statusConnectFacebook" class="btn btn-light">
                                       Not connected
                                    </button>
                                 </a>
                              </div>
                           </div>
                        </div>

                        <div class="list-item p-4" data-id="13" data-item-sortable-id="0" draggable="true" role="option"
                           aria-grabbed="false">
                           <div>
                              <img src="../images/logo_github.png" width="30px" alt="" srcset="">
                           </div>
                           <div class="flex">
                              <div href="#" class="item-author text-color" data-abc="true">Github</div>
                           </div>
                           <div class="no-wrap">
                              <div class="item-date text-muted text-sm d-none d-md-block">
                                 <a href="#">
                                    <button id="statusConnectGithub" class="btn btn-light">
                                       Not connected
                                    </button>
                                 </a>
                              </div>
                           </div>
                        </div>

                        <div class="list-item p-4" data-id="13" data-item-sortable-id="0" draggable="true" role="option"
                           aria-grabbed="false">
                           <div>
                              <img src="../images/logo_linkedin.png" width="30px" alt="" srcset="">
                           </div>
                           <div class="flex">
                              <div href="#" class="item-author text-color" data-abc="true">Linkedin</div>
                           </div>
                           <div class="no-wrap">
                              <div class="item-date text-muted text-sm d-none d-md-block">
                                 <a href="#">
                                    <button id="statusConnectLinkedin" class="btn btn-light">
                                       Not connected
                                    </button>
                                 </a>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</body>

</html>